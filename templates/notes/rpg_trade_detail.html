{% extends "base.html" %}
{% block content %}

<h2 class="fw-bold mb-3">Intercambio #{{ trade.id }} üîÅ</h2>

<div class="d-flex flex-wrap gap-2 mb-3">
  <a href="{% url 'rpg_trades' %}" class="btn btn-outline-secondary btn-sm rounded-pill">
    ‚Üê Volver a intercambios
  </a>
</div>

<div class="row g-3">
  <!-- Resumen -->
  <div class="col-lg-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="fw-bold mb-2">Resumen</h5>

        <p class="mb-1" style="font-size: 0.9rem;">
          Emisor: <strong>{{ trade.from_user.username }}</strong><br>
          Receptor: <strong>{{ trade.to_user.username }}</strong>
        </p>

        <p class="mb-1" style="font-size: 0.9rem;">
          Estado:
          {% if trade.status == "pending" %}
            <span class="badge bg-warning text-dark">Pendiente</span>
          {% elif trade.status == "accepted" %}
            <span class="badge bg-success">Aceptado</span>
          {% elif trade.status == "rejected" %}
            <span class="badge bg-danger">Rechazado</span>
          {% else %}
            <span class="badge bg-secondary">Cancelado</span>
          {% endif %}
        </p>

        <hr class="my-2">

        <h6 class="fw-bold" style="font-size: 0.95rem;">Desde tu perspectiva</h6>
        <p class="mb-1" style="font-size: 0.85rem;">
          T√∫ entregas:
          {% if is_from_side %}
            <strong>{{ trade.from_coins }}</strong> monedas y
            <strong>{{ trade.offered_from.count }}</strong> objeto(s).
          {% else %}
            <strong>{{ trade.to_coins }}</strong> monedas y
            <strong>{{ trade.offered_to.count }}</strong> objeto(s).
          {% endif %}
        </p>
        <p class="mb-2" style="font-size: 0.85rem;">
          T√∫ recibes:
          {% if is_from_side %}
            <strong>{{ trade.to_coins }}</strong> monedas y
            <strong>{{ trade.offered_to.count }}</strong> objeto(s).
          {% else %}
            <strong>{{ trade.from_coins }}</strong> monedas y
            <strong>{{ trade.offered_from.count }}</strong> objeto(s).
          {% endif %}
        </p>

        <hr class="my-2">

        <p class="mb-1" style="font-size: 0.85rem;">
          Tus monedas: <strong>{{ my_profile.coins }}</strong>
        </p>
        <p class="mb-0" style="font-size: 0.85rem;">
          Monedas de {{ other.username }}: <strong>{{ other_profile.coins }}</strong>
        </p>
      </div>
    </div>
  </div>

  <!-- Detalle y edici√≥n -->
  <div class="col-lg-8">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="fw-bold mb-3">Detalle del intercambio</h5>

        {% if trade.status == "pending" %}
        <p class="text-muted" style="font-size: 0.85rem;">
          Puedes ajustar la oferta de ambos lados y mandar una contra-oferta, o aceptar si est√°s conforme.
        </p>
        {% else %}
        <p class="text-muted" style="font-size: 0.85rem;">
          Este intercambio ya no est√° activo, solo se muestra como historial.
        </p>
        {% endif %}

        <div class="row">
          <div class="col-md-6">
            <h6 class="fw-bold" style="font-size: 0.9rem;">
              Lo que da {{ trade.from_user.username }}
            </h6>
            <ul class="mb-1" style="font-size: 0.85rem;">
              <li>Monedas: <strong>{{ trade.from_coins }}</strong></li>
              <li>Objetos: {{ trade.offered_from.count }}</li>
            </ul>
          </div>
          <div class="col-md-6">
            <h6 class="fw-bold" style="font-size: 0.9rem;">
              Lo que da {{ trade.to_user.username }}
            </h6>
            <ul class="mb-1" style="font-size: 0.85rem;">
              <li>Monedas: <strong>{{ trade.to_coins }}</strong></li>
              <li>Objetos: {{ trade.offered_to.count }}</li>
            </ul>
          </div>
        </div>

        {% if trade.status == "pending" %}
        <hr class="my-3">

        <!-- Formulario de contra-oferta -->
        <form method="post" class="mb-3">
          {% csrf_token %}
          <input type="hidden" name="action" value="counter">

          <div class="row">
            <!-- Lado from_user -->
            <div class="col-md-6">
              <h6 class="fw-bold" style="font-size: 0.9rem;">
                Aporta: {{ trade.from_user.username }}
              </h6>

              <div class="mb-2">
                <label class="form-label" style="font-size: 0.85rem;">
                  Monedas que entrega:
                </label>
                <input type="number" name="from_coins"
                       class="form-control form-control-sm"
                       min="0" value="{{ trade.from_coins }}">
              </div>

              <div class="mb-2">
                <label class="form-label" style="font-size: 0.85rem;">
                  Objetos que entrega:
                </label>
                <div class="border rounded p-2"
                     style="max-height: 180px; overflow-y: auto; font-size: 0.8rem;">

                  {% if trade.from_user.id == my_profile.user.id %}
                    {% for item in my_items %}
                      <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               name="from_items"
                               value="{{ item.id }}"
                               id="from_item_{{ item.id }}"
                               {% if item in trade.offered_from.all %}checked{% endif %}>
                        <label class="form-check-label" for="from_item_{{ item.id }}">
                          {{ item.name }}
                        </label>
                      </div>
                    {% endfor %}
                  {% else %}
                    {% for item in other_items %}
                      <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               name="from_items"
                               value="{{ item.id }}"
                               id="from_item_{{ item.id }}"
                               {% if item in trade.offered_from.all %}checked{% endif %}>
                        <label class="form-check-label" for="from_item_{{ item.id }}">
                          {{ item.name }}
                        </label>
                      </div>
                    {% endfor %}
                  {% endif %}

                </div>
              </div>
            </div>

            <!-- Lado to_user -->
            <div class="col-md-6">
              <h6 class="fw-bold" style="font-size: 0.9rem;">
                Aporta: {{ trade.to_user.username }}
              </h6>

              <div class="mb-2">
                <label class="form-label" style="font-size: 0.85rem;">
                  Monedas que entrega:
                </label>
                <input type="number" name="to_coins"
                       class="form-control form-control-sm"
                       min="0" value="{{ trade.to_coins }}">
              </div>

              <div class="mb-2">
                <label class="form-label" style="font-size: 0.85rem;">
                  Objetos que entrega:
                </label>
                <div class="border rounded p-2"
                     style="max-height: 180px; overflow-y: auto; font-size: 0.8rem;">

                  {% if trade.to_user.id == my_profile.user.id %}
                    {% for item in my_items %}
                      <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               name="to_items"
                               value="{{ item.id }}"
                               id="to_item_{{ item.id }}"
                               {% if item in trade.offered_to.all %}checked{% endif %}>
                        <label class="form-check-label" for="to_item_{{ item.id }}">
                          {{ item.name }}
                        </label>
                      </div>
                    {% endfor %}
                  {% else %}
                    {% for item in other_items %}
                      <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               name="to_items"
                               value="{{ item.id }}"
                               id="to_item_{{ item.id }}"
                               {% if item in trade.offered_to.all %}checked{% endif %}>
                        <label class="form-check-label" for="to_item_{{ item.id }}">
                          {{ item.name }}
                        </label>
                      </div>
                    {% endfor %}
                  {% endif %}

                </div>
              </div>
            </div>
          </div>

          <button type="submit" class="btn btn-primary btn-sm mt-2">
            Enviar contra-oferta
          </button>
        </form>

        <!-- Acciones: aceptar / rechazar / cancelar -->
        <div class="d-flex flex-wrap gap-2">
          <!-- Aceptar -->
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="accept">
            <button type="submit"
                    class="btn btn-success btn-sm"
                    onclick="return confirm('¬øAceptar este intercambio tal como est√°?');">
              Aceptar intercambio
            </button>
          </form>

          <!-- Rechazar (solo receptor) -->
          {% if me.id == trade.to_user.id %}
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="reject">
            <button type="submit"
                    class="btn btn-outline-danger btn-sm"
                    onclick="return confirm('¬øRechazar este intercambio?');">
              Rechazar
            </button>
          </form>
          {% endif %}

          <!-- Cancelar (solo emisor) -->
          {% if me.id == trade.from_user.id %}
          <form method="post">
            {% csrf_token %}
            <input type="hidden" name="action" value="cancel">
            <button type="submit"
                    class="btn btn-outline-secondary btn-sm"
                    onclick="return confirm('¬øCancelar este intercambio?');">
              Cancelar
            </button>
          </form>
          {% endif %}
        </div>

        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %}
