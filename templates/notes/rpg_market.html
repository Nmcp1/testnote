{% extends "base.html" %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h3 class="fw-bold mb-0">ğŸ›ï¸ Mercado de objetos</h3>
  <a href="{% url 'rpg_hub' %}" class="btn btn-outline-secondary btn-sm rounded-pill">
    â¬… Volver al Hub RPG
  </a>
</div>

<div class="row g-3">
  <!-- COLUMNA IZQUIERDA: mercado global -->
  <div class="col-lg-8">
    <div class="card shadow-sm h-100">
      <div class="card-body">

        <div class="d-flex justify-content-between align-items-center mb-2">
          <h5 class="fw-bold mb-0">Ofertas disponibles</h5>

          <form method="get" class="d-flex align-items-center gap-2">
            <label class="small mb-0">Filtrar rareza:</label>
            <select name="rarity" class="form-select form-select-sm" onchange="this.form.submit()">
              <option value="all" {% if rarity_filter == 'all' %}selected{% endif %}>Todas</option>
              {% for code, label in item_rarity_choices %}
              <option value="{{ code }}" {% if rarity_filter == code %}selected{% endif %}>
                {{ label }}
              </option>
              {% endfor %}
            </select>
          </form>
        </div>

        {% if listings %}
        <div class="row g-3">
          {% for listing in listings %}
          <div class="col-md-6">
            <div class="card h-100">
              <div class="card-body py-2">

                <div class="d-flex justify-content-between mb-1">
                  <div>
                    <div class="small text-muted">Vendedor: @{{ listing.seller.username }}</div>
                    <div class="fw-bold" style="font-size:0.95rem;">
                      {{ listing.item.name }}
                    </div>
                  </div>
                  <span class="badge bg-light text-dark border small">
                    {{ listing.item.get_rarity_display }}
                  </span>
                </div>

                <div class="small text-muted mb-2">
                  ATK {{ listing.item.attack }} Â· DEF {{ listing.item.defense }} Â· HP {{ listing.item.hp }}<br>
                  Crit {{ listing.item.crit_chance }}% Â· Esquive {{ listing.item.dodge_chance }}% Â· Velocidad {{ listing.item.speed }}
                </div>

                <div class="d-flex justify-content-between align-items-center">
                  <span class="fw-bold text-warning">
                    ğŸ’° {{ listing.price_coins }} monedas
                  </span>

                  {% if listing.seller_id == request.user.id %}
                    <form method="post" action="{% url 'rpg_market_cancel' listing.id %}">
                      {% csrf_token %}
                      <button class="btn btn-outline-danger btn-sm">Cancelar</button>
                    </form>
                  {% else %}
                    <form method="post" action="{% url 'rpg_market_buy' listing.id %}">
                      {% csrf_token %}
                      <button class="btn btn-success btn-sm">Comprar</button>
                    </form>
                  {% endif %}
                </div>
              </div>
            </div>
          </div>
          {% endfor %}
        </div>
        {% else %}
          <p class="text-muted small mb-0">No hay objetos en venta con ese filtro.</p>
        {% endif %}
      </div>
    </div>
  </div>

  <!-- COLUMNA DERECHA: publicaciones propias y poner en venta -->
  <div class="col-lg-4">
    <!-- Tus publicaciones -->
    <div class="card shadow-sm mb-3">
      <div class="card-body">
        <h6 class="fw-bold mb-2">Tus publicaciones activas</h6>
        {% if my_listings %}
          <ul class="list-group list-group-flush small">
            {% for listing in my_listings %}
            <li class="list-group-item d-flex justify-content-between align-items-center px-0">
              <div>
                <div class="fw-bold">{{ listing.item.name }}</div>
                <div class="text-muted">
                  {{ listing.item.get_rarity_display }} Â· {{ listing.price_coins }} ğŸª™
                </div>
              </div>
              <form method="post" action="{% url 'rpg_market_cancel' listing.id %}">
                {% csrf_token %}
                <button class="btn btn-sm btn-outline-danger">Cancelar</button>
              </form>
            </li>
            {% endfor %}
          </ul>
        {% else %}
          <p class="text-muted small mb-0">No tienes objetos en venta.</p>
        {% endif %}
      </div>
    </div>

    <!-- Poner en venta -->
    <div class="card shadow-sm">
      <div class="card-body">
        <h6 class="fw-bold mb-2">Poner objeto en venta</h6>
        <p class="text-muted small">
          El objeto se retirarÃ¡ temporalmente de tu inventario mientras estÃ© listado.
        </p>

        {% if available_items %}
        <div class="small" style="max-height: 320px; overflow-y:auto;">
          {% for item in available_items %}
          <form method="post" action="{% url 'rpg_market_list_item' item.id %}" class="border rounded p-2 mb-2">
            {% csrf_token %}
            <div class="d-flex justify-content-between align-items-center mb-1">
              <div>
                <div class="fw-bold" style="font-size:0.9rem;">{{ item.name }}</div>
                <div class="text-muted">
                  {{ item.get_rarity_display }} Â· ATK {{ item.attack }} Â· DEF {{ item.defense }} Â· HP {{ item.hp }}
                </div>
              </div>
            </div>
            <div class="d-flex align-items-center gap-2">
              <input type="number" name="price" min="1" class="form-control form-control-sm" placeholder="Precio">
              <button class="btn btn-outline-primary btn-sm">Vender</button>
            </div>
          </form>
          {% endfor %}
        </div>
        {% else %}
          <p class="text-muted small mb-0">No tienes objetos disponibles para vender.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %}
