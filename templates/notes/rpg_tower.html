{% extends "base.html" %}
{% block content %}

<h2 class="fw-bold mb-2">RPG ‚Äî Torre de combate üóº</h2>

<div class="d-flex flex-wrap gap-2 mb-2">
    <a href="{% url 'rpg_hub' %}" class="btn btn-outline-secondary btn-sm rounded-pill">
        ‚Üê Volver al hub
    </a>
    <a href="{% url 'rpg_shop' %}" class="btn btn-outline-primary btn-sm rounded-pill">
        üõí Tienda
    </a>
    <a href="{% url 'rpg_inventory' %}" class="btn btn-outline-primary btn-sm rounded-pill">
        üéí Inventario
    </a>
    <a href="{% url 'rpg_gacha' %}" class="btn btn-outline-primary btn-sm rounded-pill">
        ‚≠ê Gacha
    </a>
</div>

<div class="row g-3">
    <!-- Columna izquierda: monedas + stats + acciones -->
    <div class="col-lg-7">
        <div class="card shadow-sm">
            <div class="card-body py-3">

                <!-- Fila superior: progreso diario de monedas -->
                <div class="d-flex justify-content-between align-items-center mb-2">
                    <div>
                        <h6 class="fw-bold mb-1">Monedas diarias</h6>
                        <small class="text-muted">
                            {{ tower.daily_coins }}/100 (m√°x. por d√≠a)
                        </small>
                    </div>
                    <div class="flex-grow-1 ms-3">
                        <div class="progress" style="height: 14px;">
                            <div class="progress-bar bg-warning text-dark fw-semibold"
                                 role="progressbar"
                                 style="width: {{ tower.daily_coins }}%;"
                                 aria-valuenow="{{ tower.daily_coins }}" aria-valuemin="0" aria-valuemax="100">
                                <span style="font-size: 0.7rem;">
                                    {{ tower.daily_coins }}%
                                </span>
                            </div>
                        </div>
                    </div>
                </div>

                <hr class="my-2">

                <!-- Stats + piso -->
                <div class="row">
                    <div class="col-md-6">
                        <h6 class="fw-bold mb-1">Estado del jugador</h6>
                        <p class="mb-1" style="font-size: 0.9rem;">Vida: <strong>{{ stats.hp }}</strong></p>
                        <p class="mb-1" style="font-size: 0.9rem;">Ataque: <strong>{{ stats.attack }}</strong></p>
                        <p class="mb-1" style="font-size: 0.9rem;">Defensa: <strong>{{ stats.defense }}</strong></p>
                        <p class="mb-1" style="font-size: 0.9rem;">Cr√≠tico: <strong>{{ stats.crit_chance }}%</strong></p>
                        <p class="mb-1" style="font-size: 0.9rem;">Esquive: <strong>{{ stats.dodge_chance }}%</strong></p>
                        <p class="mb-0" style="font-size: 0.9rem;">Velocidad: <strong>{{ stats.speed }}</strong></p>
                    </div>

                    <div class="col-md-6 d-flex flex-column justify-content-between mt-3 mt-md-0">
                        <div>
                            <h6 class="fw-bold mb-1">Progreso en la torre</h6>
                            <p class="mb-1" style="font-size: 0.9rem;">
                                Piso actual: <strong>{{ tower.current_floor }}</strong>
                            </p>
                            <p class="mb-2" style="font-size: 0.9rem;">
                                M√°x. piso alcanzado: <strong>{{ tower.max_floor_reached }}</strong>
                            </p>
                        </div>

                        <div class="mt-2">
                            <form method="post" class="d-flex flex-wrap gap-2 mb-1">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="fight">
                                <button type="submit" class="btn btn-primary btn-sm rounded-pill">
                                    ‚öîÔ∏è Luchar en el siguiente piso
                                </button>
                            </form>

                            <form method="post" class="mb-0">
                                {% csrf_token %}
                                <input type="hidden" name="action" value="reset">
                                <button type="submit"
                                        class="btn btn-outline-danger btn-sm rounded-pill"
                                        onclick="return confirm('¬øReiniciar el progreso actual de la torre?');">
                                    Reiniciar progreso actual
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

            </div>
        </div>
    </div>

    <!-- Columna derecha: ranking -->
    <div class="col-lg-5">
        <div class="card shadow-sm h-100">
            <div class="card-body py-3">
                <h5 class="card-title fw-bold mb-2">Top jugadores de la torre üèÜ</h5>

                <table class="table table-sm align-middle mb-0" style="font-size: 0.9rem;">
                    <thead>
                        <tr>
                            <th style="width: 10%;">#</th>
                            <th style="width: 60%;">Usuario</th>
                            <th style="width: 30%;">M√°x. piso</th>
                        </tr>
                    </thead>
                    <tbody>
                    {% for t in top_players %}
                        <tr {% if t.user == request.user %}class="table-warning fw-semibold"{% endif %}>
                            <td>{{ forloop.counter }}</td>
                            <td>@{{ t.user.username }}</td>
                            <td>{{ t.max_floor_reached }}</td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="3" class="text-muted">
                                A√∫n no hay registros en la torre.
                            </td>
                        </tr>
                    {% endfor %}
                    </tbody>
                </table>
            </div>
        </div>
    </div>
</div>

<!-- √öltimo combate (abajo, ocupando ancho completo pero compacto) -->
<div class="card shadow-sm mt-3">
    <div class="card-body py-3">
        <h5 class="card-title fw-bold mb-2">√öltimo combate</h5>
        {% if last_battle %}
            <p class="mb-1" style="font-size: 0.9rem;">
                Piso: <strong>{{ last_battle.floor }}</strong> ‚Äî
                {% if last_battle.victory %}
                    <span class="badge bg-success">Victoria</span>
                {% else %}
                    <span class="badge bg-danger">Derrota</span>
                {% endif %}
            </p>
            <pre class="bg-light p-2 rounded small"
                 style="max-height: 220px; overflow-y: auto; white-space: pre-wrap;">
{{ last_battle.log_text }}
            </pre>
        {% else %}
            <p class="text-muted mb-0">
                A√∫n no has peleado en la torre. ¬°Empieza tu primer combate!
            </p>
        {% endif %}
    </div>
</div>

{% endblock %}
