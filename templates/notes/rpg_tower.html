{% extends 'base.html' %}
{% block content %}

<div class="d-flex justify-content-between align-items-center mb-3">
  <h2 class="fw-bold mb-0">Torre PVE üè∞</h2>
  <a href="{% url 'rpg_hub' %}" class="btn btn-outline-secondary">Volver al hub RPG</a>
</div>

<p class="text-muted">
  Cada piso superado otorga monedas (piso N ‚Üí N monedas), con un m√°ximo de
  <strong>100 monedas diarias</strong> obtenidas desde la torre.
</p>

<div class="row g-4 mb-4">
  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="fw-bold">Tu progreso</h5>
        <p>Piso actual: <strong>{{ tower.current_floor }}</strong></p>
        <p>Piso m√°ximo: <strong>{{ tower.max_floor_reached }}</strong></p>
        <p>Monedas: <strong>{{ profile.coins }}</strong></p>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="reset">
          <button class="btn btn-outline-danger btn-sm" type="submit">Reiniciar piso actual</button>
        </form>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm">
      <div class="card-body">
        <h5 class="fw-bold">Stats totales</h5>
        <ul class="mb-0">
          <li>Vida: <strong>{{ stats.hp }}</strong></li>
          <li>Ataque: <strong>{{ stats.attack }}</strong></li>
          <li>Defensa: <strong>{{ stats.defense }}</strong></li>
          <li>Cr√≠tico: <strong>{{ stats.crit_chance|floatformat:1 }}%</strong></li>
          <li>Esquive: <strong>{{ stats.dodge_chance|floatformat:1 }}%</strong></li>
          <li>Velocidad: <strong>{{ stats.speed }}</strong></li>
        </ul>
      </div>
    </div>
  </div>

  <div class="col-md-4">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="fw-bold">Acci√≥n</h5>
        <p>
          Luchar√°s contra el enemigo del
          <strong>piso {{ tower.current_floor|add:1 }}</strong>.
        </p>
        <form method="post">
          {% csrf_token %}
          <input type="hidden" name="action" value="fight">
          <button class="btn btn-primary w-100 btn-lg">Iniciar combate</button>
        </form>
      </div>
    </div>
  </div>
</div>

{% if last_battle %}
<div class="card shadow-sm mb-4">
  <div class="card-body">
    <h5 class="fw-bold">√öltima batalla (Piso {{ last_battle.floor }})</h5>
    <p>
      Resultado:
      {% if last_battle.victory %}
        <span class="badge bg-success">Victoria</span>
      {% else %}
        <span class="badge bg-danger">Derrota</span>
      {% endif %}
    </p>
    <pre class="bg-light p-3 rounded small" style="max-height: 300px; overflow-y: auto;">{{ last_battle.log_text }}</pre>
  </div>
</div>
{% endif %}

<div class="card shadow-sm">
  <div class="card-body">
    <h5 class="fw-bold mb-3">Top 10 ‚Äî Pisos m√°s altos üèÜ</h5>
    {% if top_players %}
      <table class="table table-sm mb-0">
        <thead class="table-light">
          <tr>
            <th>#</th>
            <th>Usuario</th>
            <th>Piso m√°ximo</th>
          </tr>
        </thead>
        <tbody>
          {% for tp in top_players %}
          <tr>
            <td>{{ forloop.counter }}</td>
            <td>@{{ tp.user.username }}</td>
            <td>{{ tp.max_floor_reached }}</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    {% else %}
      <p class="text-muted mb-0">A√∫n no hay jugadores en la torre.</p>
    {% endif %}
  </div>
</div>

{% endblock %}
