{% extends "base.html" %}
{% block content %}

<style>
  .rarity-basic { color: #9e9e9e; }
  .rarity-uncommon { color: #4caf50; }
  .rarity-special { color: #2196f3; }
  .rarity-epic { color: #9c27b0; }
  .rarity-legendary { color: #e9e636e0; font-weight: bold; }
  .rarity-mythic { color: #f44336; font-weight: bold; }
  .rarity-ascended { color: #e91e63; font-weight: bold; }

  .gacha-sidebar-btn {
    border-radius: 0;
    font-weight: 600;
    padding: 1.2rem 0;
  }
</style>

<div class="row g-3">

  <!-- Barra lateral: selector de tipo de gacha -->
  <div class="col-md-2 col-lg-2">
    <div class="d-flex flex-column h-100 border rounded">
      <a href="{% url 'rpg_gacha' %}?gtype=normal"
         class="btn gacha-sidebar-btn w-100 {% if gacha_type == 'normal' %}btn-dark text-white{% else %}btn-light{% endif %}">
        Cl√°sico
      </a>

      <a href="{% url 'rpg_gacha' %}?gtype=premium"
         class="btn gacha-sidebar-btn w-100 border-top {% if gacha_type == 'premium' %}btn-dark text-white{% else %}btn-light{% endif %}">
        Premium
      </a>

      <button type="button"
              class="btn gacha-sidebar-btn w-100 border-top btn-light text-muted"
              disabled>
        Pr√≥ximamente
      </button>

      <div class="flex-grow-1 border-top bg-light"></div>
    </div>
  </div>

  <!-- Contenido principal -->
  <div class="col-md-10 col-lg-10">

    <div class="card shadow-sm mb-3">
      <div class="card-header d-flex justify-content-between align-items-center flex-wrap gap-2">
        <div>
          <span class="fs-5 fw-bold">‚≠ê Gacha de Equipamiento</span>
          {% if gacha_type == 'normal' %}
            <span class="badge bg-primary ms-2">Normal</span>
          {% else %}
            <span class="badge bg-warning text-dark ms-2">Premium</span>
          {% endif %}
        </div>

        <div class="d-flex align-items-center gap-3 flex-wrap">
          <span class="fw-semibold">
            Usuario: {{ request.user.username }}
          </span>
          <span class="fw-semibold text-warning">
            Monedas: {{ profile.coins }}
          </span>
          <span class="fw-semibold text-danger">
            Rub√≠es: {{ profile.rubies }}
          </span>
          <a href="{% url 'rpg_hub' %}" class="btn btn-outline-secondary btn-sm">
            ‚Üê Volver al Hub RPG
          </a>
        </div>
      </div>

      <div class="card-body">

        <div class="row g-3">
          <!-- Tirar gacha -->
          <div class="col-lg-6">
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title mb-3">Tirar gacha</h5>

                <form method="post" class="mb-3">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="roll">
                  <input type="hidden" name="gtype" value="{{ gacha_type }}">

                  {% if gacha_type == 'normal' %}
                    <div class="mb-3">
                      <label for="slot" class="form-label">Tipo de equipamiento</label>
                      <select id="slot" name="slot" class="form-select">
                        {% for slot in GACHA_SLOTS %}
                          <option value="{{ slot.value }}"
                                  {% if last_slot == slot.value %}selected{% endif %}>
                            {{ slot.label }}
                          </option>
                        {% endfor %}
                      </select>
                    </div>
                    <button type="submit" class="btn btn-primary">
                      üé≤ Tirar (15 ü™ô)
                    </button>
                  {% else %}
                    <p class="mb-3">
                      Este gacha utiliza una <strong>pool completa</strong> de equipo (arma, casco, armadura,
                      pantalones, botas, escudo y amuletos). No es posible elegir tipo de objeto.
                    </p>
                    <button type="submit" class="btn btn-warning text-dark">
                      üé≤ Tirar Premium (300 ü™ô)
                    </button>
                  {% endif %}
                </form>

                <!-- Resultado de la √∫ltima tirada -->
                {% if rolled_item %}
                  <div class="alert alert-success py-2">
                    <strong>¬°Has obtenido!</strong><br>
                    <span class="rarity-{{ rolled_item.rarity }}">
                      {{ rolled_item.name }}
                    </span>
                  </div>
                {% endif %}

                {% if auto_sold %}
                  <div class="alert alert-info py-2 mb-0">
                    El objeto obtenido se vendi√≥ autom√°ticamente por
                    <strong>{{ auto_sell_gain }}</strong> monedas.
                  </div>
                {% endif %}

              </div>
            </div>
          </div>

          <!-- Probabilidades -->
          <div class="col-lg-6">
            <div class="card h-100">
              <div class="card-body">
                <h5 class="card-title mb-3">Probabilidades</h5>

                <div class="table-responsive">
                  <table class="table table-sm align-middle mb-0">
                    <thead>
                      <tr>
                        <th>Rareza</th>
                        <th class="text-end">%</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for row in probabilities %}
                        <tr>
                          <td>
                            <span class="rarity-{{ row.code }}">
                              {{ row.label }}
                            </span>
                          </td>
                          <td class="text-end">
                            {{ row.percent|floatformat:4 }}%
                          </td>
                        </tr>
                      {% endfor %}

                      {% if ruby_percent %}
                        <tr>
                          <td>
                            <span class="text-danger fw-semibold">
                              +1 Rub√≠
                            </span>
                          </td>
                          <td class="text-end">
                            {{ ruby_percent|floatformat:4 }}%
                          </td>
                        </tr>
                      {% endif %}
                    </tbody>
                  </table>
                </div>

              </div>
            </div>
          </div>
        </div>

        <!-- Vender rub√≠es -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Vender rub√≠es</h5>
                <p class="text-muted" style="font-size: 0.9rem;">
                  Puedes cambiar rub√≠es por monedas de oro. La tasa actual es:
                  <strong>1 rub√≠ = 2.500 ü™ô</strong>.
                </p>

                <form method="post" class="row g-2 align-items-end">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="sell_rubies">
                  <input type="hidden" name="gtype" value="{{ gacha_type }}">

                  <div class="col-6 col-md-4">
                    <label for="rubies_to_sell" class="form-label">Cantidad de rub√≠es</label>
                    <input type="number"
                           class="form-control"
                           id="rubies_to_sell"
                           name="rubies_to_sell"
                           min="1"
                           max="{{ profile.rubies }}"
                           placeholder="1">
                  </div>

                  <div class="col-6 col-md-4">
                    <p class="mb-1 small text-muted">
                      Recibir√°s <strong>2.500</strong> monedas por cada rub√≠.
                    </p>
                    <p class="mb-0 fw-semibold">
                      Disponible: {{ profile.rubies }} rub√≠(es).
                    </p>
                  </div>

                  <div class="col-12 col-md-4 text-md-end">
                    <button type="submit" class="btn btn-outline-warning">
                      üíé ‚Üí ü™ô Vender rub√≠es
                    </button>
                  </div>
                </form>

              </div>
            </div>
          </div>
        </div>

        <!-- Auto vender -->
        <div class="row mt-3">
          <div class="col-12">
            <div class="card">
              <div class="card-body">
                <h5 class="card-title">Auto vender</h5>
                <p class="text-muted" style="font-size: 0.9rem;">
                  Marca las rarezas que quieres vender autom√°ticamente al obtenerlas,
                  tanto en el gacha normal como en el premium.
                </p>

                <form method="post" class="row g-2">
                  {% csrf_token %}
                  <input type="hidden" name="action" value="config_autosell">
                  <input type="hidden" name="gtype" value="{{ gacha_type }}">

                  {% for row in probabilities %}
                    <div class="col-sm-6 col-md-4">
                      <div class="form-check">
                        <input class="form-check-input"
                               type="checkbox"
                               id="auto_{{ row.code }}"
                               name="auto_sell"
                               value="{{ row.code }}"
                               {% if row.code in auto_sell_selected %}checked{% endif %}>
                        <label class="form-check-label rarity-{{ row.code }}" for="auto_{{ row.code }}">
                          {{ row.label }}
                        </label>
                      </div>
                    </div>
                  {% endfor %}

                  <div class="col-12 mt-2">
                    <button type="submit" class="btn btn-outline-danger btn-sm">
                      Guardar auto vender
                    </button>
                  </div>
                </form>

              </div>
            </div>
          </div>
        </div>

      </div> <!-- card-body -->
    </div>   <!-- card -->

  </div> <!-- col principal -->

</div> <!-- row -->

{% endblock %}
