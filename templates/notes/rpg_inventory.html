{% extends "base.html" %}
{% block content %}

<style>
  .rarity-basic { color: #9e9e9e; }        /* gris */
  .rarity-uncommon { color: #4caf50; }     /* verde */
  .rarity-special { color: #2196f3; }      /* azul */
  .rarity-epic { color: #9c27b0; }         /* morado */
  .rarity-legendary { color: #ffeb3b; font-weight: bold; }  /* amarillo */
  .rarity-mythic { color: #f44336; font-weight: bold; }     /* rojo */
  .rarity-ascended { color: #e91e63; font-weight: bold; }   /* rosado */
</style>

<h2 class="fw-bold mb-3">RPG ‚Äî Inventario üéí</h2>

<div class="d-flex flex-wrap gap-2 mb-3">
  <a href="{% url 'rpg_hub' %}" class="btn btn-outline-secondary btn-sm rounded-pill">
    ‚Üê Volver al hub
  </a>
</div>

<div class="row g-3">
  <!-- Columna izquierda: stats + equipo actual -->
  <div class="col-lg-3">
    <div class="card shadow-sm h-100">
      <div class="card-body">
        <h5 class="fw-bold mb-2">Tus estad√≠sticas</h5>

        <p class="mb-1" style="font-size: 0.9rem;">Vida: <strong>{{ stats.hp }}</strong></p>
        <p class="mb-1" style="font-size: 0.9rem;">Ataque: <strong>{{ stats.attack }}</strong></p>
        <p class="mb-1" style="font-size: 0.9rem;">Defensa: <strong>{{ stats.defense }}</strong></p>
        <p class="mb-1" style="font-size: 0.9rem;">Cr√≠tico: <strong>{{ stats.crit_chance }}%</strong></p>
        <p class="mb-1" style="font-size: 0.9rem;">Esquive: <strong>{{ stats.dodge_chance }}%</strong></p>
        <p class="mb-2" style="font-size: 0.9rem;">Velocidad: <strong>{{ stats.speed }}</strong></p>

        <hr class="my-2">

        <p class="mb-2" style="font-size: 0.9rem;">
          Monedas actuales: <strong>{{ profile.coins }}</strong>
        </p>

        <hr class="my-2">

        <h6 class="fw-bold mb-2" style="font-size: 0.95rem;">Equipamiento actual</h6>

        <div style="font-size: 0.8rem;">
          <p class="mb-1">
            Arma:
            {% if profile.equipped_weapon %}
              <span class="rarity-{{ profile.equipped_weapon.rarity }}">
                {{ profile.equipped_weapon.name }}
              </span>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </p>
          <p class="mb-1">
            Casco:
            {% if profile.equipped_helmet %}
              <span class="rarity-{{ profile.equipped_helmet.rarity }}">
                {{ profile.equipped_helmet.name }}
              </span>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </p>
          <p class="mb-1">
            Armadura:
            {% if profile.equipped_armor %}
              <span class="rarity-{{ profile.equipped_armor.rarity }}">
                {{ profile.equipped_armor.name }}
              </span>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </p>
          <p class="mb-1">
            Pantalones:
            {% if profile.equipped_pants %}
              <span class="rarity-{{ profile.equipped_pants.rarity }}">
                {{ profile.equipped_pants.name }}
              </span>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </p>
          <p class="mb-1">
            Botas:
            {% if profile.equipped_boots %}
              <span class="rarity-{{ profile.equipped_boots.rarity }}">
                {{ profile.equipped_boots.name }}
              </span>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </p>
          <p class="mb-1">
            Escudo:
            {% if profile.equipped_shield %}
              <span class="rarity-{{ profile.equipped_shield.rarity }}">
                {{ profile.equipped_shield.name }}
              </span>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </p>
          <p class="mb-1">
            Amuleto 1:
            {% if profile.equipped_amulet1 %}
              <span class="rarity-{{ profile.equipped_amulet1.rarity }}">
                {{ profile.equipped_amulet1.name }}
              </span>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </p>
          <p class="mb-1">
            Amuleto 2:
            {% if profile.equipped_amulet2 %}
              <span class="rarity-{{ profile.equipped_amulet2.rarity }}">
                {{ profile.equipped_amulet2.name }}
              </span>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </p>
          <p class="mb-1">
            Amuleto 3:
            {% if profile.equipped_amulet3 %}
              <span class="rarity-{{ profile.equipped_amulet3.rarity }}">
                {{ profile.equipped_amulet3.name }}
              </span>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </p>

          <!-- Mascota -->
          <p class="mb-0">
            Mascota:
            {% if profile.equipped_pet %}
              <span class="rarity-{{ profile.equipped_pet.rarity }}">
                {{ profile.equipped_pet.name }}
              </span>
            {% else %}
              <span class="text-muted">‚Äî</span>
            {% endif %}
          </p>
        </div>

      </div>
    </div>
  </div>

  <!-- Columna derecha: inventario -->
  <div class="col-lg-9">
    <div class="card shadow-sm">
      <div class="card-body">
        <div class="d-flex justify-content-between align-items-center mb-3 flex-wrap gap-2">
          <h5 class="fw-bold mb-0">Objetos en tu inventario</h5>

          <!-- Filtro por tipo -->
          <form method="get" class="d-flex align-items-center gap-2">
            <label for="slot" class="form-label mb-0" style="font-size: 0.9rem;">Filtrar por tipo:</label>
            <select id="slot" name="slot" class="form-select form-select-sm" onchange="this.form.submit()">
              <option value="all" {% if slot_filter == "all" %}selected{% endif %}>Todos</option>
              <option value="weapon" {% if slot_filter == "weapon" %}selected{% endif %}>Arma</option>
              <option value="helmet" {% if slot_filter == "helmet" %}selected{% endif %}>Casco</option>
              <option value="armor" {% if slot_filter == "armor" %}selected{% endif %}>Armadura</option>
              <option value="pants" {% if slot_filter == "pants" %}selected{% endif %}>Pantalones</option>
              <option value="boots" {% if slot_filter == "boots" %}selected{% endif %}>Botas</option>
              <option value="shield" {% if slot_filter == "shield" %}selected{% endif %}>Escudo</option>
              <option value="amulet" {% if slot_filter == "amulet" %}selected{% endif %}>Amuletos</option>
              <option value="pet" {% if slot_filter == "pet" %}selected{% endif %}>Mascotas</option>
            </select>
          </form>
        </div>

        {% if items %}
        <div class="table-responsive">
          <table class="table table-sm align-middle">
            <thead>
              <tr>
                <th style="width: 2rem;"></th>
                <th>Nombre</th>
                <th>Tipo</th>
                <th>Rareza</th>
                <th>Stats</th>
                <th class="text-center">Estado</th>
                <th class="text-end">Acciones</th>
              </tr>
            </thead>
            <tbody>
            {% for item in items %}
              <tr>
                <td>
                  <input type="checkbox"
                         form="bulk-sell-form"
                         name="selected_items"
                         value="{{ item.id }}">
                </td>
                <td>
                  <span class="rarity-{{ item.rarity }}">
                    {{ item.name }}
                  </span>
                </td>
                <td>
                  {% if item.get_slot_display %}
                    {{ item.get_slot_display }}
                  {% else %}
                    {{ item.slot }}
                  {% endif %}
                </td>
                <td>
                  <span class="rarity-{{ item.rarity }}">
                    {% if item.get_rarity_display %}
                      {{ item.get_rarity_display }}
                    {% else %}
                      {{ item.rarity }}
                    {% endif %}
                  </span>
                </td>
                <td style="font-size: 0.8rem;">
                  ATK {{ item.attack }} |
                  DEF {{ item.defense }} |
                  HP {{ item.hp }} |
                  CRIT {{ item.crit_chance }}% |
                  ESQ {{ item.dodge_chance }}% |
                  VEL {{ item.speed }}
                </td>
                <td class="text-center">
                  {% if item.id in equipped_ids %}
                    <span class="badge bg-success">Equipado</span>
                  {% else %}
                    <span class="badge bg-secondary">En mochila</span>
                  {% endif %}
                </td>
                <td class="text-end">

                  <!-- Formulario para equipar -->
                  <form method="post" class="d-inline-block">
                    {% csrf_token %}
                    <input type="hidden" name="action" value="equip">
                    <input type="hidden" name="item_id" value="{{ item.id }}">

                    {% if item.slot == "amulet" %}
                      <select name="amulet_slot" class="form-select form-select-sm d-inline-block w-auto me-1">
                        <option value="1">A1</option>
                        <option value="2">A2</option>
                        <option value="3">A3</option>
                      </select>
                    {% endif %}

                    <button type="submit" class="btn btn-sm btn-primary">
                      Equipar
                    </button>
                  </form>

                </td>
              </tr>
            {% endfor %}
            </tbody>
          </table>
        </div>

        <!-- Formulario de venta m√∫ltiple -->
        <form id="bulk-sell-form" method="post" class="mt-2">
          {% csrf_token %}
          <input type="hidden" name="action" value="sell_bulk">
          <button type="submit"
                  class="btn btn-danger btn-sm"
                  onclick="return confirm('¬øEst√°s seguro que quieres vender todos los items seleccionados?');">
            Vender todos los items seleccionados
          </button>
        </form>

        {% else %}
          <p class="text-muted mb-0">No tienes objetos en tu inventario a√∫n.</p>
        {% endif %}
      </div>
    </div>
  </div>
</div>

{% endblock %}
